name: iOS TestFlight Auto Upload

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: ios-testflight-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-submit-ios:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Write App Store Connect API key
        env:
          ASC_API_KEY_P8: ${{ secrets.ASC_API_KEY_P8 }}
        run: |
          if [ -z "$ASC_API_KEY_P8" ]; then
            echo "ASC_API_KEY_P8 is missing"
            exit 1
          fi
          printf "%s" "$ASC_API_KEY_P8" > AuthKey.p8

      - name: Validate CI secrets for submit
        env:
          EXPO_ASC_KEY_ID: ${{ secrets.ASC_API_KEY_ID }}
          EXPO_ASC_ISSUER_ID: ${{ secrets.ASC_API_ISSUER_ID }}
        run: |
          [ -n "$EXPO_ASC_KEY_ID" ] || (echo "ASC_API_KEY_ID is missing" && exit 1)
          [ -n "$EXPO_ASC_ISSUER_ID" ] || (echo "ASC_API_ISSUER_ID is missing" && exit 1)
          [ -s "AuthKey.p8" ] || (echo "AuthKey.p8 is empty" && exit 1)
          echo "Secrets look present."

      - name: Build iOS and auto-submit to TestFlight
        env:
          EXPO_ASC_API_KEY_PATH: AuthKey.p8
          EXPO_ASC_KEY_ID: ${{ secrets.ASC_API_KEY_ID }}
          EXPO_ASC_ISSUER_ID: ${{ secrets.ASC_API_ISSUER_ID }}
          APPLE_TEAM_ID: Z8CBPVNKKW
          EAS_BUILD_NO_EXPO_GO_WARNING: "1"
        run: |
          set -euo pipefail
          npx eas-cli@latest whoami

          attempts=3
          build_ok=0
          for attempt in $(seq 1 "$attempts"); do
            echo "Starting EAS build attempt ${attempt}/${attempts}..."

            set +e
            output=$(npx eas-cli@latest build \
              --platform ios \
              --profile production \
              --non-interactive \
              --auto-submit-with-profile production \
              --wait 2>&1)
            status=$?
            set -e

            printf "%s\n" "$output"

            if [ "$status" -eq 0 ]; then
              echo "EAS build+submit succeeded."
              build_ok=1
              break
            fi

            if [ "$attempt" -lt "$attempts" ] && echo "$output" | grep -Eiq "services aren't available right now|service unavailable|gateway timeout|timed out|ECONNRESET|EAI_AGAIN|5[0-9]{2}"; then
              sleep_sec=$((attempt * 30))
              echo "Detected transient service/network error. Retrying in ${sleep_sec}s..."
              sleep "$sleep_sec"
              continue
            fi

            break
          done

          if [ "$build_ok" -ne 1 ]; then
            summary=$(printf "%s\n" "$output" | grep -E "(Error:|Failed to|âœ–|Submission failed|Build failed|unauthorized|forbidden|not found)" | tail -n 1 || true)
            if [ -z "$summary" ]; then
              summary=$(printf "%s\n" "$output" | tail -n 1)
            fi
            summary=$(printf "%s" "$summary" | tr '\n' ' ' | cut -c1-350)
            echo "::error title=EAS build failed::${summary}"
            exit "${status:-1}"
          fi
